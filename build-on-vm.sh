#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Å–±–æ—Ä–∫–∏ –æ–±—Ä–∞–∑–∞ Orange Pi 3B –Ω–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./build-on-vm.sh

set -e

echo "üöÄ –ó–∞–ø—É—Å–∫ —Å–±–æ—Ä–∫–∏ –æ–±—Ä–∞–∑–∞ Orange Pi 3B Coptra –Ω–∞ VM"
echo "=================================================="

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ root
if [ "$EUID" -ne 0 ]; then
    echo "‚ùå –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç —Å –ø—Ä–∞–≤–∞–º–∏ root: sudo ./build-on-vm.sh"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –∫–æ–º–∞–Ω–¥
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
for cmd in qemu-aarch64-static kpartx parted unzip wget curl git; do
    if ! command -v $cmd &> /dev/null; then
        echo "‚ùå –ö–æ–º–∞–Ω–¥–∞ $cmd –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:"
        echo "   apt install -y qemu-user-static kpartx parted unzip wget curl git"
        exit 1
    fi
done

# –ü—Ä–æ–≤–µ—Ä–∫–∞ binfmt
if ! update-binfmts --status | grep -q "qemu-aarch64"; then
    echo "‚ö†Ô∏è  –ù–∞—Å—Ç—Ä–æ–π–∫–∞ binfmt –¥–ª—è QEMU..."
    update-binfmts --enable qemu-aarch64
fi

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
export DEBIAN_FRONTEND=noninteractive
export TZ=UTC
export LANG=C.UTF-8
export LC_ALL=C.UTF-8

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞
AVAILABLE_SPACE=$(df . | tail -1 | awk '{print $4}')
if [ "$AVAILABLE_SPACE" -lt 10485760 ]; then  # 10GB –≤ KB
    echo "‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞. –ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 10GB"
    echo "   –î–æ—Å—Ç—É–ø–Ω–æ: $((AVAILABLE_SPACE / 1024 / 1024))GB"
    exit 1
fi

echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã"
echo "üíæ –°–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ: $((AVAILABLE_SPACE / 1024 / 1024))GB"

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –æ–±—Ä–∞–∑–æ–≤ –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
mkdir -p images

# –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö loop —É—Å—Ç—Ä–æ–π—Å—Ç–≤
echo "üßπ –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö loop —É—Å—Ç—Ä–æ–π—Å—Ç–≤..."
losetup -D 2>/dev/null || true

# –°–¥–µ–ª–∞—Ç—å —Å–∫—Ä–∏–ø—Ç—ã –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º–∏
echo "üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–∫—Ä–∏–ø—Ç–æ–≤..."
chmod +x builder/*.sh

# –ó–∞–ø—É—Å–∫ —Å–±–æ—Ä–∫–∏
echo "üèóÔ∏è  –ù–∞—á–∏–Ω–∞–µ–º —Å–±–æ—Ä–∫—É –æ–±—Ä–∞–∑–∞..."
echo "   –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 1-3 —á–∞—Å–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –º–æ—â–Ω–æ—Å—Ç–∏ VM"
echo ""

# –ó–∞–ø—É—Å–∫ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞ —Å–±–æ—Ä–∫–∏
./builder/image-build.sh

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
if [ $? -eq 0 ]; then
    echo ""
    echo "üéâ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!"
    echo "üìÅ –û–±—Ä–∞–∑ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –ø–∞–ø–∫–µ images/"
    ls -la images/*.img 2>/dev/null || echo "   –û–±—Ä–∞–∑—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
    
    # –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å–∂–∞—Ç—å –æ–±—Ä–∞–∑
    echo ""
    read -p "üóúÔ∏è  –°–∂–∞—Ç—å –æ–±—Ä–∞–∑ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞? (y/N): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        echo "üóúÔ∏è  –°–∂–∏–º–∞–µ–º –æ–±—Ä–∞–∑..."
        for img in images/*.img; do
            if [ -f "$img" ]; then
                echo "   –°–∂–∏–º–∞–µ–º $img..."
                xz -9 "$img"
                echo "   ‚úÖ –ì–æ—Ç–æ–≤–æ: ${img}.xz"
            fi
        done
    fi
    
    echo ""
    echo "üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
    echo "   1. –°–∫–∞—á–∞–π—Ç–µ –æ–±—Ä–∞–∑ —Å VM"
    echo "   2. –ó–∞–ø–∏—à–∏—Ç–µ –Ω–∞ microSD –∫–∞—Ä—Ç—É —Å –ø–æ–º–æ—â—å—é balenaEtcher"
    echo "   3. –í—Å—Ç–∞–≤—å—Ç–µ –∫–∞—Ä—Ç—É –≤ Orange Pi 3B –∏ –≤–∫–ª—é—á–∏—Ç–µ"
    echo "   4. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ WiFi 'coptra-XXXX' (–ø–∞—Ä–æ–ª—å: coptrawifi)"
    echo "   5. –û—Ç–∫—Ä–æ–π—Ç–µ http://192.168.11.1 –≤ –±—Ä–∞—É–∑–µ—Ä–µ"
    
else
    echo ""
    echo "‚ùå –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–æ–π!"
    echo "üîç –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤—ã—à–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏"
    exit 1
fi
