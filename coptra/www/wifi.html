<!DOCTYPE html>
<html lang="en">
<head>
	<title>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ WiFi - Coptra</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="style.css">
	<link rel="icon" href="data:,">
</head>
<body>
	<div class="header">
		<h1><img src="coptra_icon_128.png" alt="Coptra"> Coptra Drone Kit</h1>
		<div class="subtitle">–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –¥—Ä–æ–Ω–∞</div>
	</div>

	<div class="container">
		<div class="wifi-dashboard">
			<div class="page-header">
				<h1 class="page-title">üì∂ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ WiFi</h1>
				<a href="index.html" class="back-btn">‚Üê –ù–∞–∑–∞–¥</a>
			</div>
			<div class="page-subtitle">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ—Ç–µ–≤—ã—Ö —Ä–µ–∂–∏–º–æ–≤ –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</div>
			
			<div class="status-grid">
				<div class="status-card">
					<div class="status-label">–¢–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º</div>
					<div class="status-value" id="current-mode">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
				</div>
				<div class="status-card">
					<div class="status-label">WiFi –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å</div>
					<div class="status-value" id="wifi-status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
				</div>
				<div class="status-card">
					<div class="status-label">Ethernet</div>
					<div class="status-value" id="eth-status">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
				</div>
				<div class="status-card">
					<div class="status-label">IP –∞–¥—Ä–µ—Å</div>
					<div class="status-value" id="ip-address">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
				</div>
			</div>
			
			<div class="mode-selector">
				<div class="mode-card" data-mode="ap" onclick="switchMode('ap')">
					<span class="mode-icon">üì°</span>
					<div class="mode-title">–¢–æ—á–∫–∞ –¥–æ—Å—Ç—É–ø–∞</div>
					<div class="mode-description">
						–°–æ–∑–¥–∞—Ç—å WiFi —Ö–æ—Ç—Å–ø–æ—Ç –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –¥—Ä—É–≥–∏—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤.
						SSID: <span id="current-ssid-display">coptra-XXXX</span>, –ü–∞—Ä–æ–ª—å: coptrawifi
					</div>
					<span class="mode-status inactive" id="ap-status">–ù–µ–∞–∫—Ç–∏–≤–µ–Ω</span>
				</div>
				
				<div class="mode-card" data-mode="client" onclick="switchMode('client')">
					<span class="mode-icon">üì∂</span>
					<div class="mode-title">WiFi –∫–ª–∏–µ–Ω—Ç</div>
					<div class="mode-description">
						–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º WiFi —Å–µ—Ç—è–º —á–µ—Ä–µ–∑ NetworkManager.
						–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π.
					</div>
					<span class="mode-status inactive" id="client-status">–ù–µ–∞–∫—Ç–∏–≤–µ–Ω</span>
				</div>
				
				<div class="mode-card" data-mode="eth0" onclick="switchMode('eth0')">
					<span class="mode-icon">üîå</span>
					<div class="mode-title">–¢–æ–ª—å–∫–æ Ethernet</div>
					<div class="mode-description">
						–û—Ç–∫–ª—é—á–∏—Ç—å WiFi –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ Ethernet –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.
						–ü–æ–ª–µ–∑–Ω–æ –¥–ª—è –ø—Ä–æ–≤–æ–¥–Ω—ã—Ö —Å—Ä–µ–¥.
					</div>
					<span class="mode-status inactive" id="eth0-status">–ù–µ–∞–∫—Ç–∏–≤–µ–Ω</span>
				</div>
			</div>
			
			<!-- WiFi Scanner Section -->
			<div class="wifi-scanner-section">
				<h3 style="text-align: center; margin-bottom: 20px; color: #333;">üì° –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ WiFi —Å–µ—Ç–µ–π</h3>
				<div class="scanner-controls">
					<button class="control-btn primary" onclick="scanWiFiNetworks()">
						<span>üîç</span>
						<span>–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Ç–∏</span>
					</button>
					<button class="control-btn" onclick="clearWiFiList()">
						<span>üóëÔ∏è</span>
						<span>–û—á–∏—Å—Ç–∏—Ç—å —Å–ø–∏—Å–æ–∫</span>
					</button>
				</div>
				
				<div class="wifi-networks-list" id="wifi-networks-list">
					<div class="no-networks" id="no-networks">
						<p>–ù–∞–∂–º–∏—Ç–µ "–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Ç–∏" –¥–ª—è –ø–æ–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö WiFi —Å–µ—Ç–µ–π</p>
					</div>
				</div>
			</div>
			
			<div class="controls-section">
				<h3 style="text-align: center; margin-bottom: 20px; color: #333;">–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h3>
				<div class="control-buttons">
					<button class="control-btn" onclick="refreshStatus()">
						<span>üîÑ</span>
						<span>–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å</span>
					</button>
					<button class="control-btn" onclick="showNetworkInfo()">
						<span>‚ÑπÔ∏è</span>
						<span>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Ç–∏</span>
					</button>
					<button class="control-btn primary" onclick="restartServices()">
						<span>‚ö°</span>
						<span>–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã</span>
					</button>
				</div>
			</div>
		</div>
	</div>
	
	<div class="notification" id="notification"></div>
	
	<!-- WiFi Connection Modal -->
	<div class="wifi-modal" id="wifi-modal">
		<div class="wifi-modal-content">
			<div class="wifi-modal-header">
				<h3 class="wifi-modal-title">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WiFi —Å–µ—Ç–∏</h3>
				<button class="wifi-modal-close" onclick="closeWiFiModal()">&times;</button>
			</div>
			<form id="wifi-connection-form">
				<div class="wifi-form-group">
					<label class="wifi-form-label" for="wifi-ssid">–ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ—Ç–∏ (SSID)</label>
					<input type="text" class="wifi-form-input" id="wifi-ssid" readonly>
				</div>
				<div class="wifi-form-group">
					<label class="wifi-form-label" for="wifi-password">–ü–∞—Ä–æ–ª—å</label>
					<input type="password" class="wifi-form-input" id="wifi-password" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å WiFi —Å–µ—Ç–∏">
				</div>
				<div class="wifi-form-actions">
					<button type="button" class="wifi-btn wifi-btn-secondary" onclick="closeWiFiModal()">–û—Ç–º–µ–Ω–∞</button>
					<button type="submit" class="wifi-btn wifi-btn-primary">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
				</div>
			</form>
		</div>
	</div>
	
	<script type="text/javascript" src="js/notifications.js"></script>
	<script>
		let currentMode = 'unknown';
		
		// Show notification
		// Using global notifications system
		
		// Switch network mode
		async function switchMode(mode) {
			if (mode === currentMode) {
				notifications.info('–£–∂–µ –≤ —Ä–µ–∂–∏–º–µ ' + mode);
				return;
			}
			
			notifications.info('–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤ —Ä–µ–∂–∏–º ' + mode + '...');
			
			try {
                const response = await fetch('/cgi-bin/network-switch', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify({ mode: mode })
				});
				
				if (!response.ok) {
					throw new Error(`HTTP ${response.status}: ${response.statusText}`);
				}
				
				notifications.success('–£—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–æ –≤ —Ä–µ–∂–∏–º ' + mode);
				setTimeout(refreshStatus, 2000);
				
			} catch (error) {
				// Only show error notification if it's not a network error
				if (!error.message.includes('NetworkError') && !error.message.includes('fetch')) {
					notifications.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞: ' + error.message);
				} else {
					notifications.error('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.');
				}
			}
		}
		
		// Refresh status
		async function refreshStatus() {
			try {
                const response = await fetch('/cgi-bin/network-status');
				
				if (!response.ok) {
					throw new Error(`HTTP ${response.status}: ${response.statusText}`);
				}
				
				const data = await response.json();
				
				// Update status display
				document.getElementById('current-mode').textContent = data.currentMode || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
				document.getElementById('wifi-status').textContent = data.wifiStatus || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
				document.getElementById('eth-status').textContent = data.ethStatus || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
				document.getElementById('ip-address').textContent = data.ipAddress || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
				
				// Update SSID display
				if (data.currentSSID && data.currentSSID !== 'unknown') {
					document.getElementById('current-ssid-display').textContent = data.currentSSID;
				}
				
				// Update mode cards
				document.querySelectorAll('.mode-card').forEach(card => {
					card.classList.remove('active');
					const status = card.querySelector('.mode-status');
					status.classList.remove('active');
					status.classList.add('inactive');
					status.textContent = '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω';
				});
				
				if (data.currentMode) {
					const activeCard = document.querySelector(`[data-mode="${data.currentMode}"]`);
					if (activeCard) {
						activeCard.classList.add('active');
						const status = activeCard.querySelector('.mode-status');
						status.classList.remove('inactive');
						status.classList.add('active');
						status.textContent = '–ê–∫—Ç–∏–≤–µ–Ω';
					}
				}
				
				currentMode = data.currentMode || 'unknown';
				
			} catch (error) {
				// Set default values when network fails
				document.getElementById('current-mode').textContent = '–û—Ñ–ª–∞–π–Ω';
				document.getElementById('wifi-status').textContent = '–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ';
				document.getElementById('eth-status').textContent = '–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ';
				document.getElementById('ip-address').textContent = '–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ';
				
				// Reset all mode cards to inactive
				document.querySelectorAll('.mode-card').forEach(card => {
					card.classList.remove('active');
					const status = card.querySelector('.mode-status');
					status.classList.remove('active');
					status.classList.add('inactive');
					status.textContent = '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω';
				});
				
				// Only show error notification if it's not a network error
				if (!error.message.includes('NetworkError') && !error.message.includes('fetch')) {
					notifications.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞: ' + error.message);
				}
			}
		}
		
		// Show network information
		function showNetworkInfo() {
			const info = `
–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–µ—Ç–∏:
- SSID —Ç–æ—á–∫–∏ –¥–æ—Å—Ç—É–ø–∞: ${data.currentSSID || 'coptra-XXXX'}
- –ü–∞—Ä–æ–ª—å —Ç–æ—á–∫–∏ –¥–æ—Å—Ç—É–ø–∞: coptrawifi
- IP —Ç–æ—á–∫–∏ –¥–æ—Å—Ç—É–ø–∞: 192.168.11.1
- –í–µ–± –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: http://192.168.11.1
- –¢–µ—Ä–º–∏–Ω–∞–ª—å–Ω—ã–π –¥–æ—Å—Ç—É–ø: http://192.168.11.1:57575
- –í–∏–¥–µ–æ–ø–æ—Ç–æ–∫: http://192.168.11.1:8080

–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:
- network-switch ap     # –ó–∞–ø—É—Å—Ç–∏—Ç—å WiFi —Ö–æ—Ç—Å–ø–æ—Ç
- network-switch client # –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ WiFi —Å–µ—Ç–∏
- network-switch eth0   # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ Ethernet
- network-switch status # –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å
			`;
			alert(info);
		}
		
		// Restart network services
		async function restartServices() {
			if (!confirm('–≠—Ç–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç –≤—Å–µ —Å–µ—Ç–µ–≤—ã–µ —Å–µ—Ä–≤–∏—Å—ã. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) {
				return;
			}
			
			notifications.info('–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ç–µ–≤—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤...');
			
			try {
                const response = await fetch('/cgi-bin/restart-network', {
					method: 'POST'
				});
				
				if (!response.ok) {
					throw new Error(`HTTP ${response.status}: ${response.statusText}`);
				}
				
				notifications.success('–°–µ—Ç–µ–≤—ã–µ —Å–µ—Ä–≤–∏—Å—ã —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω—ã');
				setTimeout(refreshStatus, 3000);
				
			} catch (error) {
				// Only show error notification if it's not a network error
				if (!error.message.includes('NetworkError') && !error.message.includes('fetch')) {
					notifications.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤: ' + error.message);
				} else {
					notifications.error('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.');
				}
			}
		}
		
		// WiFi Scanner Functions
		let wifiNetworks = [];
		
		// Scan for available WiFi networks
		async function scanWiFiNetworks() {
			notifications.info('–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ WiFi —Å–µ—Ç–µ–π...');
			
			try {
                const response = await fetch('/cgi-bin/wifi-scan');
				
				if (!response.ok) {
					throw new Error(`HTTP ${response.status}: ${response.statusText}`);
				}
				
				const networks = await response.json();
				
				if (networks.error) {
					throw new Error(networks.error);
				}
				
				wifiNetworks = networks;
				displayWiFiNetworks(networks);
				
				if (networks.length > 0) {
					notifications.success(`–ù–∞–π–¥–µ–Ω–æ ${networks.length} WiFi —Å–µ—Ç–µ–π`);
				} else {
					notifications.warning('WiFi —Å–µ—Ç–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
				}
				
			} catch (error) {
				console.error('WiFi scan error:', error);
				notifications.error('–û—à–∏–±–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è WiFi: ' + error.message);
			}
		}
		
		// Display WiFi networks in the list
		function displayWiFiNetworks(networks) {
			const listContainer = document.getElementById('wifi-networks-list');
			const noNetworks = document.getElementById('no-networks');
			
			if (networks.length === 0) {
				noNetworks.style.display = 'block';
				return;
			}
			
			noNetworks.style.display = 'none';
			
			// Clear existing networks
			listContainer.innerHTML = '';
			
			networks.forEach(network => {
				const networkItem = createWiFiNetworkItem(network);
				listContainer.appendChild(networkItem);
			});
		}
		
		// Create WiFi network item element
		function createWiFiNetworkItem(network) {
			const item = document.createElement('div');
			item.className = 'wifi-network-item';
			
			const signalStrength = getSignalStrength(network.signal);
			const securityIcon = getSecurityIcon(network.security);
			
			item.innerHTML = `
				<div class="wifi-network-info">
					<div class="wifi-network-ssid">${network.ssid}</div>
					<div class="wifi-network-details">
						<div class="wifi-signal-strength">
							<div class="signal-bars">
								${signalStrength}
							</div>
							<span>${network.signal || 'N/A'}</span>
						</div>
						<div class="wifi-security">
							${securityIcon}
							<span>${network.security || 'Open'}</span>
						</div>
					</div>
				</div>
				<button class="wifi-connect-btn" onclick="connectToWiFi('${network.ssid}', '${network.security}')">
					–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è
				</button>
			`;
			
			return item;
		}
		
		// Get signal strength bars
		function getSignalStrength(signal) {
			if (!signal) return '<div class="signal-bar"></div><div class="signal-bar"></div><div class="signal-bar"></div><div class="signal-bar"></div>';
			
			const signalNum = parseInt(signal);
			let activeBars = 0;
			
			if (signalNum >= 75) activeBars = 4;
			else if (signalNum >= 50) activeBars = 3;
			else if (signalNum >= 25) activeBars = 2;
			else if (signalNum > 0) activeBars = 1;
			
			let bars = '';
			for (let i = 1; i <= 4; i++) {
				bars += `<div class="signal-bar ${i <= activeBars ? 'active' : ''}"></div>`;
			}
			
			return bars;
		}
		
		// Get security icon
		function getSecurityIcon(security) {
			if (security === 'Open') {
				return '<span>üîì</span>';
			} else if (security === 'WPA' || security === 'WPA/WEP') {
				return '<span>üîí</span>';
			} else {
				return '<span>üîê</span>';
			}
		}
		
		// Connect to WiFi network
		function connectToWiFi(ssid, security) {
			// Check if password is required
			if (security !== 'Open') {
				showWiFiModal(ssid);
			} else {
				// Connect to open network
				connectToNetwork(ssid, '');
			}
		}
		
		// Show WiFi connection modal
		function showWiFiModal(ssid) {
			const modal = document.getElementById('wifi-modal');
			const ssidInput = document.getElementById('wifi-ssid');
			const passwordInput = document.getElementById('wifi-password');
			
			ssidInput.value = ssid;
			passwordInput.value = '';
			passwordInput.focus();
			
			modal.style.display = 'block';
		}
		
		// Close WiFi modal
		function closeWiFiModal() {
			const modal = document.getElementById('wifi-modal');
			modal.style.display = 'none';
		}
		
		// Clear WiFi networks list
		function clearWiFiList() {
			const listContainer = document.getElementById('wifi-networks-list');
			const noNetworks = document.getElementById('no-networks');
			
			listContainer.innerHTML = '';
			noNetworks.style.display = 'block';
			wifiNetworks = [];
		}
		
		// Connect to network
		async function connectToNetwork(ssid, password) {
			notifications.info(`–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ç–∏ ${ssid}...`);
			
			try {
                const response = await fetch('/cgi-bin/wifi-connect', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify({ 
						ssid: ssid, 
						password: password 
					})
				});
				
				if (!response.ok) {
					throw new Error(`HTTP ${response.status}: ${response.statusText}`);
				}
				
				const result = await response.json();
				
				if (result.status === 'success') {
					notifications.success(result.message);
					closeWiFiModal();
					// Refresh status after connection
					setTimeout(refreshStatus, 3000);
				} else {
					notifications.error(result.message);
				}
				
			} catch (error) {
				console.error('WiFi connection error:', error);
				notifications.error('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + error.message);
			}
		}
		
		// Handle WiFi connection form submission
		document.getElementById('wifi-connection-form').addEventListener('submit', function(e) {
			e.preventDefault();
			
			const ssid = document.getElementById('wifi-ssid').value;
			const password = document.getElementById('wifi-password').value;
			
			if (!ssid) {
				notifications.error('SSID –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
				return;
			}
			
			connectToNetwork(ssid, password);
		});
		
		// Close modal when clicking outside
		window.addEventListener('click', function(e) {
			const modal = document.getElementById('wifi-modal');
			if (e.target === modal) {
				closeWiFiModal();
			}
		});
		
		// Initialize page
		document.addEventListener('DOMContentLoaded', function() {
			refreshStatus();
			
			// Auto-refresh every 10 seconds
			setInterval(refreshStatus, 10000);
		});
	</script>
</body>
</html>
